@model ShibpurConnectWebApp.Models.WebAPI.UserProfile

@{
    ViewBag.Title = "All Users - ShibpurHub";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!--this knockout js will save the token in the session storage and we want to make the call only when user is logged in-->
@if (User.Identity.IsAuthenticated)
{
    @section Scripts{
        @Scripts.Render("~/bundles/knockout")
        @Scripts.Render("~/bundles/app")
    }
}

<style type="text/css">
    body {
        background: #ECEFF1;
    }

    .user {
        /*margin-bottom:20px;*/
    }

    #userlist {
        margin-top: 20px;
    }

    .moduleheader {
        font-size: 18px;
    }

    .input-group {
        width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    /*align loading div centered*/
    #loadingusers {
        width: 200px;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    /*typehead css*/

    .tt-query {
        -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
    }

    .tt-hint {
        color: #999;
    }

    .tt-dropdown-menu {
        width: 422px;
        margin-top: 4px;
        padding: 4px 0;
        background-color: #fff;
        border: 1px solid #ccc;
        border: 1px solid rgba(0, 0, 0, 0.2);
        -webkit-border-radius: 4px;
        -moz-border-radius: 4px;
        border-radius: 4px;
        -webkit-box-shadow: 0 5px 10px rgba(0,0,0,.2);
        -moz-box-shadow: 0 5px 10px rgba(0,0,0,.2);
        box-shadow: 0 5px 10px rgba(0,0,0,.2);
    }

    .tt-suggestion {
        padding: 3px 20px;
        line-height: 24px;
    }

        .tt-suggestion.tt-cursor {
            color: #fff;
            background-color: #0097cf;
        }

        .tt-suggestion p {
            margin: 0;
        }

    .profileimage {
        width: 90px;
        height: 90px;
        margin: auto;
        overflow: hidden;
        -webkit-border-radius: 50px;
        -moz-border-radius: 50px;
        border-radius: 50px;
        background-color: #f2f2f2;
        background-size: cover;
        background-position: top center;
        text-align: center;
    }

    div.user .profile {
        display: block;
        background: #FFF;
        padding: 10px;
        -webkit-box-shadow: rgba(0,0,0,.0980392) 0 2px 4px,rgba(0,0,0,.0980392) 0 0 3px;
        -moz-box-shadow: rgba(0,0,0,.0980392) 0 2px 4px,rgba(0,0,0,.0980392) 0 0 3px;
        box-shadow: rgba(0,0,0,.0980392) 0 2px 4px,rgba(0,0,0,.0980392) 0 0 3px;
        margin: 10px 0;
        text-decoration: none;
        /*text-align: center;*/
        /*-webkit-transition: background,.2s,fade,.2s;
        -moz-transition: background,.2s,fade,.2s;
        -ms-transition: background,.2s,fade,.2s;
        -o-transition: background,.2s,fade,.2s;
        transition: background,.2s,fade,.2s;*/
    }

    .profile a {
        display: inline-block;
        width: 100%;
        margin: 10px 0;
        font-size: 1.1em;
        color: #1F9684;
        font-weight: 400;
        margin-top: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-align: center;
        text-overflow: ellipsis;
    }

    div.user .profile span {
        color: #455A64;
    }

    div.rep-count {
        display: inline-block;
        height: 32px;
        font-size: 13px;
        font-weight: 500;
        color: rgba(0,0,0,0.6);
        line-height: 32px;
        padding: 0 12px;
        border-radius: 16px;
        background-color: #f5f5f5;
    }

    div.follow-small {
        display: inline-block;
        margin-top: 0;
        overflow: hidden;
        color: #ADB3B2;
        text-decoration: none;
        line-height: 1;        
        float: right;
        cursor:pointer;

        text-align: center; 
        border-radius: 50%;
        height: 30px;
        width: 30px;
        padding-left: 1px;
        padding-top: 7px;
        padding-left: 1px;
        border: solid 1px #CFD8DC;
    }

    div.follow-small.active {
        color: #4DB6AC;
        padding-top: 6px;
        padding-left: 0;
    }

    div.follow-small:hover {
        background: #CFD8DC;
    }
    
    .table
    {
        background: white;
        margin-top: 25px;
    }
    
    /*div.user a.profile:hover
    {
        color: #fff;
        background: #1F9684;
    }

    div.user a.profile:hover h3, div.user a.profile:hover span
    {
        color: #fff;
    }*/
</style>
<script type="text/javascript">
    // variable to keep the all users data that we will receive from the api, and will use this when
    // user will clear the search text from the search box
    var allusers;
    var userDetails = localStorage.getItem("SC_Session_UserDetails");
    var userInfo = $.parseJSON(userDetails);
    var loggedInUserid = userInfo == null ? "" : userInfo.id;
    function handleFollowClick()
    {
        $('.follow-small').each(function (i, e) {
            $(e).unbind('click');
            $(e).click(function () {
                var button = $(this);
                var profileid = $(button).attr('id');
                if ($(button).hasClass('active'))
                {
                    unfollowuser(null, profileid);
                }
                else
                {
                    followuser(null, profileid);
                }

                $(button).toggleClass('active');
                $(button).find('i.fa').toggleClass('fa-plus fa-check');
            });
        });
    }
    
    function handleToggleViewClick()
    {
        $('.toggle-view').click(function(event){
            event.preventDefault();
            var button = $(this);
            var icon = $(button).find('i.fa');
            if($(button).hasClass('grid-view'))
            {
                $(icon).removeClass('fa-list').addClass('fa-th');
            }
            else
            {
                $(icon).removeClass('fa-th').addClass('fa-list');
            }
            
            $(button).toggleClass('grid-view');
            $('#userlist').toggle();
            $('.table').toggle();
        });
    }

    function getProfileHtml(userinfo)
    {
        var profileImgUrl = userinfo.profileImageURL == null ? "/Content/images/profile-image.jpg" : IMGURPATH + userinfo.profileImageURL;
        var followingClass = $.inArray(loggedInUserid, userinfo.followers) == -1 ? "" : "active";
        var iconClass = followingClass == "active" ? "fa-check" : "fa-plus";
        if (loggedInUserid == "" || loggedInUserid == userinfo.id)
        {
            followingClass = "hide";
        }
        
        
        var row = $("<tr>");
        $(row).append($('<td>').text(userinfo.firstName + " " + userinfo.lastName));
        $(row).append($('<td>').text(userinfo.educationInfo));
        $(row).append($('<td>').text(userinfo.designation));
        $(row).append($('<td>').text(userinfo.location));
        $(row).append($('<td>').html("<a href=mailto:" + userinfo.email + "><i class='fa fa-envelope-o'></i></a>"));
        $(row).append($('<td>').html("<div class='follow-small " + followingClass + "' id=" + userinfo.id + "><i class='fa " + iconClass + "'></i> </div>"));
        
        $('.table tbody').append(row);
        
        return "<div class='user col-md-3 col-xs-12 col-sm-6'><div class='profile'> \
                <a href='/Account/Profile?userId=" + userinfo.id + "'> \
                    <div class='profileimage' style='background-image: url(" + profileImgUrl + ")'></div>" + userinfo.firstName + " " + userinfo.lastName + "</a> \
                <div class='rep-count' title='Reputation'><i class='fa fa-star-o'></i> " + userinfo.reputationCount + "</div> \
                <div class='follow-small " + followingClass + "' id=" + userinfo.id + "><i class='fa " + iconClass + "'></i> </div> </div></div>";
    }

    $(document).ready(function () {
        jQuery.support.cors = true;
        var SERVER = "/api/";
        //$('#select_categories').tokenInput("/api/categories/GetCategories");

        $('.table').hide();
        scAjax({
            "url": "users/GetAllUsers",
            "success": function (result) {
                if (!result) {
                    return;
                }

                // save the api result in the global variable 'userlist'
                allusers = result;

                // hide the loading div
                $('#loadingusers').hide();

                $(result).each(function (i, userinfo) {
                    $('#userlist').append(getProfileHtml(userinfo));
                });
                handleFollowClick();
                handleToggleViewClick();
            }
        });
    });

    // This method will execute when user will type user details in the serach box
    $(function () {
        $('#usernametext').keyup(function (event) {
            var searchValue = $(this).val();

            // enable loading div
            $('#loadingusers').show();

            setTimeout(function () {
                if (searchValue == $('#usernametext').val() && searchValue != null && searchValue != "") {
                    scAjax({
                        "url": "search/SearchUsers",
                        "data": { "searchTerm": searchValue },
                        "success": function (result) {
                            if (!result) {
                                return;
                            }

                            // clear the users
                            $('#userlist').empty();
                            // hide the loading
                            $('#loadingusers').hide();

                            // if no user found then show this message
                            if (result.length == 0) {
                                $('#userlist').append("<span>No user found</span>");
                                return;
                            }
                            else {
                                $('.table tbody tr').remove();
                                // update the div with the user data received from the API
                                $(result).each(function (i, userinfo) {
                                    $('#userlist').append(getProfileHtml(userinfo));
                                });
                                handleFollowClick();
                            }
                        }
                    });
                }
                else if (searchValue == '') {
                    // user have cleared all text from the text field so load all previous users
                    // clear the existing users
                    $('#userlist').empty();
                    // hide the loading
                    $('#loadingusers').hide();

                    // if no user found then show this message
                    if (allusers.length == 0) {
                        $('#userlist').append("<span>No user found</span>");
                        return;
                    }
                    else {
                        $(allusers).each(function (i, userinfo) {
                            $('#userlist').append(getProfileHtml(userinfo));
                        });
                        handleFollowClick();
                    }
                }
            }, 400);
        });
    });
</script>
<div>
    <div class="col-md-12">
        <div class="row subheader" style="border-bottom-style:dotted; display: none">
            <h2 class="moduleheader" style="float:left;">Users</h2>
            <div id="tabs" style="float:right">
                <ul class="nav nav-pills" role="tablist">
                    <li role="presentation"><a href="#">reputation</a></li>
                    <li role="presentation"><a href="#">new users</a></li>
                    <li role="presentation"><a href="#">admins</a></li>
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="row">
                <form role="search">
                    <div class="col-md-11">
                        <div class="input-group input-group-sm" id="the-basics">
                            <input type="text" id="usernametext" class="form-control" placeholder="Search user by name, email, company" aria-describedby="sizing-addon3">
                            @*<div class="input-group-btn">
                                <button type="button" class="btn btn-default"><i class="glyphicon glyphicon-search"></i></button>
                            </div>*@
                        </div>
                    </div>
                    <button class="btn-default toggle-view grid-view"> <i class="fa fa-list"></i> </button>
                </form>
                @*<div id="the-basics">
                    <input class="typeahead" type="text" placeholder="States of USA">
                </div>*@
            </div>
        </div>
        <div id="userlist">

        </div>
        <div id="loadingusers">
            <i class="fa fa-refresh fa-spin"></i><span> Loading....</span>
        </div>
        
        <table class="table table-condensed table-striped">
            <tbody>
            </tbody>
        </table>
        
    </div>
</div>
